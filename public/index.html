<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">















  <link rel="alternate" href="/default" title="LongMa's Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.9.0" />



<link rel="canonical" href="http://blog.sllt.me/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.9.0" />



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>








<script>
  window.config = {"title":"LongMa's Blog","subtitle":null,"description":null,"author":"sllt","language":"zh-Hans","timezone":null,"url":"http://blog.sllt.me","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":true,"tab_replace":null},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":10,"pagination_dir":"page","theme":"even","deploy":{"type":"git","repo":"git@github.com:sllt/sllt.github.com.git","branch":"master"},"ignore":[],"category_generator":{"per_page":10},"archive_generator":{"per_page":10,"yearly":true,"monthly":true,"daily":false},"index_generator":{"per_page":10,"order_by":"-date"},"tag_generator":{"per_page":10},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true},"server":{"port":4000,"log":false,"ip":"0.0.0.0","compress":false,"header":true},"since":2015,"favicon":"/favicon.ico","rss":"default","menu":{"Home":"/","Archives":"/archives/","Tags":"/tags"},"color":"Hot Pink","toc":true,"fancybox":true,"pjax":true,"copyright":{"enable":false,"license":false},"reward":{"enable":false,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"hi@sllt.me","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/sllt","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"leancloud":{"app_id":null,"app_key":null},"baidu_analytics":null,"baidu_verification":null,"google_analytics":null,"google_verification":null,"disqus_shortname":null,"changyan":{"appid":null,"appkey":null},"livere_datauid":null,"version":"2.9.0"};
</script>

    <title> LongMa's Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">LongMa's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">LongMa's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/11/09/an-experience-of-hacked-website/">一次误打误撞的提权经历</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-11-09
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>误打误撞的输入某网站的ip结果自动跳转到一个探针文件：</p>
<p><img src="http://o73uhz20r.bkt.clouddn.com/an-experience-of-hacked-website-1.png" alt=""></p>
<p>通过弱口令尝试登录数据库，测试成功！</p>
<p>phpstudy这种集成包一般也会集成phpMyAdmin， 尝试找phpMyAdmin的相对路径登录，成功登录后通过select outfile语句将一句话木马写入到web服务器根目录下（探针暴露了绝对路径）</p>
<p><img src="http://o73uhz20r.bkt.clouddn.com/an-experience-of-hacked-website-2.png" alt=""></p>
<p>测试是否写入成功</p>
<p><img src="http://o73uhz20r.bkt.clouddn.com/an-experience-of-hacked-website-3.png" alt=""></p>
<p>通过第三方工具连接一句话木马上传GetPassword.exe 并运行。</p>
<p><img src="http://o73uhz20r.bkt.clouddn.com/an-experience-of-hacked-website-4.png" alt=""></p>
<p>成功拿到密码</p>
<p><img src="http://o73uhz20r.bkt.clouddn.com/an-experience-of-hacked-website-5.png" alt=""></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/04/24/lambda-calculus/">使用Python模拟Lambda演算</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-04-24
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>我们将从下面这段程序开始：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">0</span> <span class="keyword">or</span> i % <span class="number">5</span> == <span class="number">0</span>:</span><br><span class="line">        print(i)</span><br></pre></td></tr></table></figure>
<p>这段程序将打印出1~19之间能被3或5整除的数字。我们将不使用任何Python内建类型及方法来实现上面程序的功能。</p>
<h2 id="1-数字"><a href="#1-数字" class="headerlink" title="1 数字"></a>1 数字</h2><p>数字的特征可以简单的描述为某一个动作的迭代。比如吃了6个苹果，6就表示重复的进行了n次的吃这个动作。相同的，我们也可以在程序中用某一个函数被调用了几次来表示数字。</p>
<p>比如数字<code>1</code>可以表示成如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one</span><span class="params">(p, x)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> p(x)</span><br></pre></td></tr></table></figure>
<p>依照同样的定义，我们可以这么表示<code>2</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">two</span><span class="params">(p, x)</span>:</span></span><br><span class="line">   <span class="keyword">return</span> p(p(x))</span><br></pre></td></tr></table></figure>
<p>那么， 如何表示<code>0</code>呢？ 我们传入<code>p</code>但是不进行调用，就可以表示0了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zero</span><span class="params">(p, x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<p>用<code>lambda</code>表达式表示如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZERO = <span class="keyword">lambda</span> p: <span class="keyword">lambda</span> x: x</span><br><span class="line">ONE = <span class="keyword">lambda</span> p: <span class="keyword">lambda</span> x: p(x)</span><br><span class="line">TWO = <span class="keyword">lambda</span> p: <span class="keyword">lambda</span> x: p(p(x))</span><br><span class="line">THREE = <span class="keyword">lambda</span> p: <span class="keyword">lambda</span> x: p(p(p(x)))</span><br></pre></td></tr></table></figure>
<p>让我们来实现一个函数来将这些lambda表达式这换成Python的数字，依次来支持一些其他特性，比如使用<code>range</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">to_integer = <span class="keyword">lambda</span> n: n(<span class="keyword">lambda</span> x: x+<span class="number">1</span>)(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>同样的，<code>5</code>、<code>20</code>可以这么表示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FIVE = <span class="keyword">lambda</span> p: <span class="keyword">lambda</span> x: p(p(p(p(p(x)))))</span><br><span class="line"></span><br><span class="line">TWENTY = <span class="keyword">lambda</span> p: <span class="keyword">lambda</span> x: p(p(p(p(p(p(p(p(p(p(p(p(p(p(p(p(p(p(p(p(x))))))))))))))))))))</span><br></pre></td></tr></table></figure>
<p>现在，我们的程序可以这么表示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(to_integer(ONE), to_integer(TWENTY)):</span><br><span class="line">    <span class="keyword">if</span> i % to_integer(THREE) == to_integer(ZERO) <span class="keyword">or</span> i % to_integer(FIVE) == to_integer(ZERO):</span><br><span class="line">        print(i)</span><br></pre></td></tr></table></figure>
<h1 id="2-布尔值"><a href="#2-布尔值" class="headerlink" title="2 布尔值"></a>2 布尔值</h1><p>待写…</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2015/11/25/write-a-web-server-with-python/">如何写一个web服务器</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-11-25
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>Hello, Web</p>
<p>我们先来写一个简单的web服务器，思路如下：</p>
<ol>
<li>等待客户端连接我们的服务器，并发送一个HTTP 请求；</li>
<li>解析这个请求；</li>
<li>找出它要请求的具体内容；</li>
<li>获取该数据 (或者动态生成);</li>
<li>将数据格式化为HTML；</li>
<li>返回数据。</li>
</ol>
<p>步骤1、2、6的实现方式大致相同, 在Python中有一个叫BaseHTTPServer的模块可以帮助我们实现这些步骤。 我们仅需要实现步骤3-5, 一个简单的实现如下:</p>
<pre><code>import BaseHTTPServer

class RequestHandler(BaseHTTPServer.BaseHTTPRequestHandler):
    &apos;&apos;&apos;Handle HTTP requests by returning a fixed &apos;page&apos;.&apos;&apos;&apos;

    # Page to send back.
    Page = &apos;&apos;&apos;\
&lt;html&gt;
&lt;body&gt;
&lt;p&gt;Hello, web!&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
&apos;&apos;&apos;

    # Handle a GET request.
    def do_GET(self):
        self.send_response(200)
        self.send_header(&quot;Content-Type&quot;, &quot;text/html&quot;)
        self.send_header(&quot;Content-Length&quot;, str(len(self.Page)))
        self.end_headers()
        self.wfile.write(self.Page)

#----------------------------------------------------------------------

if __name__ == &apos;__main__&apos;:
    serverAddress = (&apos;&apos;, 8080)
    server = BaseHTTPServer.HTTPServer(serverAddress, RequestHandler)
    server.serve_forever()
</code></pre><p>BaseHTTPRequestHandler类负责解析传入的HTTP请求， 并调用特定的方法。如果是GET请求，它将调用do_GET方法。我们的RequestHandler类重写了这个方法来动态的生成一个页面：返回的内容保存在类变量Page中，我们给客户端返回一个200的状态码，Content-Type用来告诉客户端将我们返回的数据为HTML，Content-Length表示返回信息的长度（end_headers方法将会插入空行用来分割HTTP头以及内容主体）。</p>
<p>但RequestHandler并不是故事的全部：我们需要调用最后三行代码来启动一个服务器。其中第一行定义了一个元组来表示服务器的地址：空字符串表示“运行在当前的机器上”，8080表示占用的端口。接着我们创建了一个BaseHTTPServer.HTTPServer的实例，然后让其一直运行（按Control-C终止）。</p>
<p>我们在命令行下运行这个程序， 并不会显示任何内容：</p>
<pre><code>$ python server.py
</code></pre><p>用浏览器打开 <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a> 我们会看到以下内容：</p>
<pre><code>Hello, web!
</code></pre><p>这时候我们的shell将会显示类似如下信息：</p>
<pre><code>127.0.0.1 - - [24/Feb/2014 10:26:28] &quot;GET / HTTP/1.1&quot; 200 -
127.0.0.1 - - [24/Feb/2014 10:26:28] &quot;GET /favicon.ico HTTP/1.1&quot; 200 -
</code></pre><p>因为我们没有指定特定的文件，浏览器默认将会访问’/‘目录（服务器的根目录）。</p>
<p>浏览器会自动发送第二个请求获取/favicon.ico图像,它会显示在地址栏上，如果它存在的话。</p>
<p>Displaying Values</p>
<p>我们来修改代码让程序返回HTTP请求的部分信息 。 为了保持代码的整洁，我们将分为几个方法来写：</p>
<pre><code>class RequestHandler(BaseHTTPServer.BaseHTTPRequestHandler):

    # ...page template...

    def do_GET(self):
        page = self.create_page()
        self.send_page(page)

    def create_page(self):
        # ...fill in...

    def send_page(self, page):
        # ...fill in...
</code></pre><p>我们需要先实现send_page方法： </p>
<pre><code>def send_page(self, page):
    self.send_response(200)
    self.send_header(&quot;Content-type&quot;, &quot;text/html&quot;)
    self.send_header(&quot;Content-Length&quot;, str(len(page)))
    self.end_headers()
    self.wfile.write(page)
</code></pre><p>将要显示的页面模板：</p>
<pre><code>    Page = &apos;&apos;&apos;\
&lt;html&gt;
&lt;body&gt;
&lt;table&gt;
&lt;tr&gt;  &lt;td&gt;Header&lt;/td&gt;         &lt;td&gt;Value&lt;/td&gt;          &lt;/tr&gt;
&lt;tr&gt;  &lt;td&gt;Date and time&lt;/td&gt;  &lt;td&gt;{date_time}&lt;/td&gt;    &lt;/tr&gt;
&lt;tr&gt;  &lt;td&gt;Client host&lt;/td&gt;    &lt;td&gt;{client_host}&lt;/td&gt;  &lt;/tr&gt;
&lt;tr&gt;  &lt;td&gt;Client port&lt;/td&gt;    &lt;td&gt;{client_port}s&lt;/td&gt; &lt;/tr&gt;
&lt;tr&gt;  &lt;td&gt;Command&lt;/td&gt;        &lt;td&gt;{command}&lt;/td&gt;      &lt;/tr&gt;
&lt;tr&gt;  &lt;td&gt;Path&lt;/td&gt;           &lt;td&gt;{path}&lt;/td&gt;         &lt;/tr&gt;
&lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
&apos;&apos;&apos;
</code></pre><p>实现create_page方法，用来格式化要显示的信息：</p>
<pre><code>def create_page(self):
    values = {
        &apos;date_time&apos;   : self.date_time_string(),
        &apos;client_host&apos; : self.client_address[0],
        &apos;client_port&apos; : self.client_address[1],
        &apos;command&apos;     : self.command,
        &apos;path&apos;        : self.path
    }
    page = self.Page.format(**values)
    return page
</code></pre><p>不需要改变程序主体: 像之前一样, 以地址、RequestHandler作为参数创建一个 HTTPServer的实例，接着程序会监听此地址。如果我们用浏览器打开<a href="http://localhost:8080/something.html，将会看到如下信息：" target="_blank" rel="noopener">http://localhost:8080/something.html，将会看到如下信息：</a>  </p>
<pre><code>Date and time  Mon, 24 Feb 2014 17:17:12 GMT
Client host    127.0.0.1
Client port    54548
Command        GET
Path           /something.html
</code></pre><p>即使something.html页面不存在程序也不会返回一个404错误。这是因为我们在获取一个HTTP请求后可以给它返回任意内容。</p>
<p>Serving Static Pages</p>
<p>接下来我们监听磁盘上的文件，将其返回给客户端。来修改do_GET方法:</p>
<pre><code>def do_GET(self):
    try:

        # Figure out what exactly is being requested.
        full_path = os.getcwd() + self.path

        # It doesn&apos;t exist...
        if not os.path.exists(full_path):
            raise ServerException(&quot;&apos;{0}&apos; not found&quot;.format(self.path))

        # ...it&apos;s a file...
        elif os.path.isfile(full_path):
            self.handle_file(full_path)

        # ...it&apos;s something we don&apos;t handle.
        else:
            raise ServerException(&quot;Unknown object &apos;{0}&apos;&quot;.format(self.path))

    # Handle errors.
    except Exception as msg:
        self.handle_error(msg)
</code></pre><p>该方法假定服务器所在目录为根目录(调用 os.getcwd方法)。然后跟URL中的地址组合在一起来寻找文件 (相对路径保存在 self.path中，并始终以’/‘开头) 。</p>
<p>如果这个文件不存在，或者不是个文件程序会抛出一个异常，并捕获它。如果这个文件存在，将会调用hand_file方法来获取文件的内容。然后调用send_content方法将读到的内容返回给客户端：</p>
<pre><code>def handle_file(self, full_path):
    try:
        with open(full_path, &apos;rb&apos;) as reader:
            content = reader.read()
        self.send_content(content)
    except IOError as msg:
        msg = &quot;&apos;{0}&apos; cannot be read: {1}&quot;.format(self.path, msg)
        self.handle_error(msg)
</code></pre><p>接着，我们来完成错误处理的方法和错误报告的页面模板：</p>
<pre><code>Error_Page = &quot;&quot;&quot;\
        &lt;html&gt;
        &lt;body&gt;
        &lt;h1&gt;Error accessing {path}&lt;/h1&gt;
        &lt;p&gt;{msg}&lt;/p&gt;
        &lt;/body&gt;
        &lt;/html&gt;
        &quot;&quot;&quot;

def handle_error(self, msg):
    content = self.Error_Page.format(path=self.path, msg=msg)
    self.send_content(content)
</code></pre><p>This program works, but only if we don’t look too closely. The problem is that it always returns a status code of 200, even when the page being requested doesn’t exist. Yes, the page sent back in that case contains an error message, but since our browser can’t read English, it doesn’t know that the request actually failed. In order to make that clear, we need to modify handle_error and send_content as follows:</p>
<pre><code># Handle unknown objects.
def handle_error(self, msg):
    content = self.Error_Page.format(path=self.path, msg=msg)
    self.send_content(content, 404)

# Send actual content.
def send_content(self, content, status=200):
    self.send_response(status)
    self.send_header(&quot;Content-type&quot;, &quot;text/html&quot;)
    self.send_header(&quot;Content-Length&quot;, str(len(content)))
    self.end_headers()
    self.wfile.write(content)
</code></pre><p>Listing Directories</p>
<p>As our next step, we could teach the web server to display a listing of a directory’s contents when the path in the URL is a directory rather than a file. We could even go one step further and have it look in that directory for an index.html file to display, and only show a listing of the directory’s contents if that file is not present.</p>
<p>But building these rules into do_GET would be a mistake, since the resulting method would be a long tangle of if statements controlling special behaviors. The right solution is to step back and solve the general problem, which is figuring out what to do with a URL. Here’s a rewrite of the do_GET method:</p>
<pre><code>def do_GET(self):
    try:

        # Figure out what exactly is being requested.
        self.full_path = os.getcwd() + self.path

        # Figure out how to handle it.
        for case in self.Cases:
            handler = case()
            if handler.test(self):
                handler.act(self)
                break

    # Handle errors.
    except Exception as msg:
        self.handle_error(msg)
</code></pre><p>The first step is the same: figure out the full path to the thing being requested. After that, though, the code looks quite different. Instead of a bunch of inline tests, this version loops over a set of cases stored in a list. Each case is an object with two methods: test, which tells us whether it’s able to handle the request, and act, which actually takes some action. As soon as we find the right case, we let it handle the request and break out of the loop.</p>
<p>These three case classes reproduce the behavior of our previous server:</p>
<pre><code>class case_no_file(object):
    &apos;&apos;&apos;File or directory does not exist.&apos;&apos;&apos;

    def test(self, handler):
        return not os.path.exists(handler.full_path)

    def act(self, handler):
        raise ServerException(&quot;&apos;{0}&apos; not found&quot;.format(handler.path))


class case_existing_file(object):
    &apos;&apos;&apos;File exists.&apos;&apos;&apos;

    def test(self, handler):
        return os.path.isfile(handler.full_path)

    def act(self, handler):
        handler.handle_file(handler.full_path)


class case_always_fail(object):
    &apos;&apos;&apos;Base case if nothing else worked.&apos;&apos;&apos;

    def test(self, handler):
        return True

    def act(self, handler):
        raise ServerException(&quot;Unknown object &apos;{0}&apos;&quot;.format(handler.path))
</code></pre><p>and here’s how we construct the list of case handlers at the top of the RequestHandler class:</p>
<pre><code>class RequestHandler(BaseHTTPServer.BaseHTTPRequestHandler):
    &apos;&apos;&apos;
    If the requested path maps to a file, that file is served.
    If anything goes wrong, an error page is constructed.
    &apos;&apos;&apos;

    Cases = [case_no_file(),
             case_existing_file(),
             case_always_fail()]

    ...everything else as before...
</code></pre><p>Now, on the surface this has made our server more complicated, not less: the file has grown from 74 lines to 99, and there’s an extra level of indirection without any new functionality. The benefit comes when we go back to the task that started this chapter and try to teach our server to serve up the index.html page for a directory if there is one, and a listing of the directory if there isn’t. The handler for the former is:</p>
<pre><code>class case_directory_index_file(object):
    &apos;&apos;&apos;Serve index.html page for a directory.&apos;&apos;&apos;

    def index_path(self, handler):
        return os.path.join(handler.full_path, &apos;index.html&apos;)

    def test(self, handler):
        return os.path.isdir(handler.full_path) and \
               os.path.isfile(self.index_path(handler))

    def act(self, handler):
        handler.handle_file(self.index_path(handler))
</code></pre><p>Here, the helper method index_path constructs the path to the index.html file; putting it in the case handler prevents clutter in the main RequestHandler.test checks whether the path is a directory containing an index.html page, and act asks the main request handler to serve that page.</p>
<p>The only change needed to RequestHandler is to add a case_directory_index_file object to our Cases list:</p>
<pre><code>Cases = [case_no_file(),
         case_existing_file(),
         case_directory_index_file(),
         case_always_fail()]
</code></pre><p>What about directories that don’t contain index.html pages? The test is the same as the one above with a not strategically inserted, but what about the actmethod? What should it do?</p>
<pre><code>class case_directory_no_index_file(object):
    &apos;&apos;&apos;Serve listing for a directory without an index.html page.&apos;&apos;&apos;

    def index_path(self, handler):
        return os.path.join(handler.full_path, &apos;index.html&apos;)

    def test(self, handler):
        return os.path.isdir(handler.full_path) and \
               not os.path.isfile(self.index_path(handler))

    def act(self, handler):
        ???
</code></pre><p>It seems we’ve backed ourselves into a corner. Logically, the act method should create and return the directory listing, but our existing code doesn’t allow for that:RequestHandler.do_GET calls act, but doesn’t expect or handle a return value from it. For now, let’s add a method to RequestHandler to generate a directory listing, and call that from the case handler’s act:</p>
<pre><code>class case_directory_no_index_file(object):
    &apos;&apos;&apos;Serve listing for a directory without an index.html page.&apos;&apos;&apos;

    # ...index_path and test as above...

    def act(self, handler):
        handler.list_dir(handler.full_path)


class RequestHandler(BaseHTTPServer.BaseHTTPRequestHandler):

    # ...all the other code...

    # How to display a directory listing.
    Listing_Page = &apos;&apos;&apos;\
        &lt;html&gt;
        &lt;body&gt;
        &lt;ul&gt;
        {0}
        &lt;/ul&gt;
        &lt;/body&gt;
        &lt;/html&gt;
        &apos;&apos;&apos;

    def list_dir(self, full_path):
        try:
            entries = os.listdir(full_path)
            bullets = [&apos;&lt;li&gt;{0}&lt;/li&gt;&apos;.format(e) 
                for e in entries if not e.startswith(&apos;.&apos;)]
            page = self.Listing_Page.format(&apos;\n&apos;.join(bullets))
            self.send_content(page)
        except OSError as msg:
            msg = &quot;&apos;{0}&apos; cannot be listed: {1}&quot;.format(self.path, msg)
            self.handle_error(msg)
</code></pre><p>The CGI Protocol</p>
<p>Of course, most people won’t want to edit the source of their web server in order to add new functionality. To save them from having to do so, servers have always supported a mechanism called the Common Gateway Interface (CGI), which provides a standard way for a web server to run an external program in order to satisfy a request.</p>
<p>For example, suppose we want the server to be able to display the local time in an HTML page. We can do this in a standalone program with just a few lines of code:</p>
<pre><code>from datetime import datetime
print &apos;&apos;&apos;\
&lt;html&gt;
&lt;body&gt;
&lt;p&gt;Generated {0}&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;&apos;&apos;&apos;.format(datetime.now())
</code></pre><p>In order to get the web server to run this program for us, we add this case handler:</p>
<pre><code>class case_cgi_file(object):
    &apos;&apos;&apos;Something runnable.&apos;&apos;&apos;

    def test(self, handler):
        return os.path.isfile(handler.full_path) and \
               handler.full_path.endswith(&apos;.py&apos;)

    def act(self, handler):
        handler.run_cgi(handler.full_path)
</code></pre><p>The test is simple: does the file path end with .py? If so, RequestHandler runs this program.</p>
<pre><code>def run_cgi(self, full_path):
    cmd = &quot;python &quot; + full_path
    child_stdin, child_stdout = os.popen2(cmd)
    child_stdin.close()
    data = child_stdout.read()
    child_stdout.close()
    self.send_content(data)
</code></pre><p>This is horribly insecure: if someone knows the path to a Python file on our server, we’re just letting them run it without worrying about what data it has access to, whether it might contain an infinite loop, or anything else.2</p>
<p>Sweeping that aside, the core idea is simple:</p>
<ol>
<li>Run the program in a subprocess.</li>
<li>Capture whatever that subprocess sends to standard output.</li>
<li>Send that back to the client that made the request.</li>
</ol>
<p>The full CGI protocol is much richer than this—in particular, it allows for parameters in the URL, which the server passes into the program being run—but those details don’t affect the overall architecture of the system…</p>
<p>…which is once again becoming rather tangled. RequestHandler initially had one method, handle_file, for dealing with content. We have now added two special cases in the form of list_dir and run_cgi. These three methods don’t really belong where they are, since they’re primarily used by others.</p>
<p>The fix is straightforward: create a parent class for all our case handlers, and move other methods to that class if (and only if) they are shared by two or more handlers. When we’re done, the RequestHandler class looks like this:</p>
<pre><code>class RequestHandler(BaseHTTPServer.BaseHTTPRequestHandler):

    Cases = [case_no_file(),
             case_cgi_file(),
             case_existing_file(),
             case_directory_index_file(),
             case_directory_no_index_file(),
             case_always_fail()]

    # How to display an error.
    Error_Page = &quot;&quot;&quot;\
        &lt;html&gt;
        &lt;body&gt;
        &lt;h1&gt;Error accessing {path}&lt;/h1&gt;
        &lt;p&gt;{msg}&lt;/p&gt;
        &lt;/body&gt;
        &lt;/html&gt;
        &quot;&quot;&quot;

    # Classify and handle request.
    def do_GET(self):
        try:

            # Figure out what exactly is being requested.
            self.full_path = os.getcwd() + self.path

            # Figure out how to handle it.
            for case in self.Cases:
                if case.test(self):
                    case.act(self)
                    break

        # Handle errors.
        except Exception as msg:
            self.handle_error(msg)

    # Handle unknown objects.
    def handle_error(self, msg):
        content = self.Error_Page.format(path=self.path, msg=msg)
        self.send_content(content, 404)

    # Send actual content.
    def send_content(self, content, status=200):
        self.send_response(status)
        self.send_header(&quot;Content-type&quot;, &quot;text/html&quot;)
        self.send_header(&quot;Content-Length&quot;, str(len(content)))
        self.end_headers()
        self.wfile.write(content)
</code></pre><p>while the parent class for our case handlers is:</p>
<pre><code>class base_case(object):
    &apos;&apos;&apos;Parent for case handlers.&apos;&apos;&apos;

    def handle_file(self, handler, full_path):
        try:
            with open(full_path, &apos;rb&apos;) as reader:
                content = reader.read()
            handler.send_content(content)
        except IOError as msg:
            msg = &quot;&apos;{0}&apos; cannot be read: {1}&quot;.format(full_path, msg)
            handler.handle_error(msg)

    def index_path(self, handler):
        return os.path.join(handler.full_path, &apos;index.html&apos;)

    def test(self, handler):
        assert False, &apos;Not implemented.&apos;

    def act(self, handler):
        assert False, &apos;Not implemented.&apos;
</code></pre><p>and the handler for an existing file (just to pick an example at random) is:</p>
<pre><code>class case_existing_file(base_case):
    &apos;&apos;&apos;File exists.&apos;&apos;&apos;

    def test(self, handler):
        return os.path.isfile(handler.full_path)

    def act(self, handler):
        self.handle_file(handler, handler.full_path)
</code></pre><p>Discussion</p>
<p>The differences between our original code and the refactored version reflect two important ideas. The first is to think of a class as a collection of related services.RequestHandler and base_case don’t make decisions or take actions; they provide tools that other classes can use to do those things.</p>
<p>The second is extensibility: people can add new functionality to our web server either by writing an external CGI program, or by adding a case handler class. The latter does require a one-line change to RequestHandler (to insert the case handler in the Cases list), but we could get rid of that by having the web server read a configuration file and load handler classes from that. In both cases, they can ignore most lower-level details, just as the authors of the BaseHTTPRequestHandlerclass have allowed us to ignore the details of handling socket connections and parsing HTTP requests.</p>
<p>These ideas are generally useful; see if you can find ways to use them in your own projects.</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2015/11/17/write-a-scheme-interpreter/">如何写一个Scheme解释器</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-11-17
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>本文假设你会使用python。</p>
<p>我们会先实现一个scheme语法的简单计算器，以便了解实现一个解释器的简单步骤，接着会逐步给此计算器增加功能，使其成为一个完整的scheme解释器。</p>
<p><a href="https://zh.wikipedia.org/wiki/Scheme" target="_blank" rel="noopener">Scheme-wikipedia</a>这里有关于scheme的更详细的介绍。</p>
<h2 id="1-1-Scheme语法式的计算器"><a href="#1-1-Scheme语法式的计算器" class="headerlink" title="1.1 Scheme语法式的计算器"></a>1.1 Scheme语法式的计算器</h2><p>此简化的计算器包含加（+）、减（-）、乘（*）、除（/）四个表达式。</p>
<p>加法和乘法表达式可以接收任意数量的参数：</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; (+ 1 2 3 4 )</span><br><span class="line"><span class="number">10</span></span><br><span class="line">&gt; (+)</span><br><span class="line"><span class="number">0</span></span><br><span class="line">&gt; (* 1 2 3 4)</span><br><span class="line"><span class="number">24</span></span><br><span class="line">&gt; (*)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>减法(<code>-</code>)有两种情况，当传入一个参数时，会求这个数的相反数；传入两个或两个以上的操作时，会<br>进行减法操作， 例如<code>(- 10 1 2 3)</code> 等同于<code>10 - 1 - 2 - 3</code>。除法(<code>/</code>)也有两种情况。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; (- 10 1 2 3)</span><br><span class="line"><span class="number">4</span></span><br><span class="line">&gt; (- 3)</span><br><span class="line"><span class="number">-3</span></span><br><span class="line">&gt; (/ 15 12)</span><br><span class="line"><span class="number">1.25</span></span><br><span class="line">&gt; (/ 30 5 2)</span><br><span class="line"><span class="number">3</span></span><br><span class="line">&gt; (/ 10)</span><br><span class="line"><span class="number">0.1</span></span><br></pre></td></tr></table></figure>
<p>一个表达式执行的时候，先会对其子表达式求值，将所得结果再执行所返回的值。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; (- 100 ( * 7 ( + 8 (/ -12 -3))))</span><br><span class="line"><span class="number">16.0</span></span><br></pre></td></tr></table></figure>
<p>接下来我们将会用python编写此求值器的解释器。大致步骤是读取一串字符串(例如: <code>(+ 1 2)</code> )，将其转换成表达式树，然后遍历表达式树，对其求值，再将求得的值输出出来。</p>
<h2 id="1-2-表达式树"><a href="#1-2-表达式树" class="headerlink" title="1.2 表达式树"></a>1.2 表达式树</h2><p>通过观察会发现所有的scheme表达式都是一个列表，这个列表的第一个值是函数名， 后面的值是这个函数<br>的参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt; s = Pair(<span class="number">1</span>, Pair(<span class="number">2</span>, nil))</span><br><span class="line">&gt;&gt;&gt;&gt; s</span><br><span class="line">Pair(<span class="number">1</span>, Pair(<span class="number">2</span>, nil))</span><br><span class="line">&gt;&gt;&gt;&gt; print(s)</span><br><span class="line">(<span class="number">1</span> <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt; len(s)</span><br><span class="line"><span class="number">2</span></span><br><span class="line">&gt;&gt;&gt;&gt; s[<span class="number">1</span>]</span><br><span class="line"><span class="number">2</span></span><br><span class="line">&gt;&gt;&gt;&gt; print(s.map(<span class="keyword">lambda</span> x: x + <span class="number">4</span>))</span><br><span class="line">(<span class="number">5</span> <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt; expr = Pair(<span class="string">'+'</span>, Pair(<span class="string">'*'</span>, Pair(<span class="number">3</span>, Pair(<span class="number">4</span>, nil))), Pair(<span class="number">5</span>, nil)))</span><br><span class="line">&gt;&gt;&gt;&gt; print(expr)</span><br><span class="line">(+ （* <span class="number">3</span> <span class="number">4</span>） <span class="number">5</span>）</span><br><span class="line">&gt;&gt;&gt;&gt; expr.second.first.second.first.second.first</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<h2 id="1-3-解析表达式"><a href="#1-3-解析表达式" class="headerlink" title="1.3 解析表达式"></a>1.3 解析表达式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt; tokenize_line(<span class="string">'(+ 1 (* 2.3 45))'</span>)</span><br><span class="line">[<span class="string">'('</span>, <span class="string">'+'</span>, <span class="number">1</span>, <span class="string">'('</span>, <span class="string">'*'</span>, <span class="number">2.3</span>, <span class="number">45</span>, <span class="string">')'</span>, <span class="string">')'</span>, <span class="string">')'</span>]</span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>lines = [<span class="string">'(+ 1'</span>, <span class="string">'   (* 2.3 45))'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>expression = scheme_read(Buffer(tokenize_lines(lines)))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>expression</span><br><span class="line">Pair(<span class="string">'+'</span>, Pair(<span class="number">1</span>, Pair(Pair(<span class="string">'*'</span>, Pair(<span class="number">2.3</span>, Pair(<span class="number">45</span>, nil))), nil)))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(expression)</span><br><span class="line">(+ <span class="number">1</span> (* <span class="number">2.3</span> <span class="number">45</span>))</span><br></pre></td></tr></table></figure>
<h2 id="1-4-求值"><a href="#1-4-求值" class="headerlink" title="1.4 求值"></a>1.4 求值</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">calc_eval</span><span class="params">(exp)</span>:</span></span><br><span class="line">        <span class="string">"""Evaluate a Calculator expression."""</span></span><br><span class="line">        <span class="keyword">if</span> type(exp) <span class="keyword">in</span> (int, float):</span><br><span class="line">            <span class="keyword">return</span> simplify(exp)</span><br><span class="line">        <span class="keyword">elif</span> isinstance(exp, Pair):</span><br><span class="line">            arguments = exp.second.map(calc_eval)</span><br><span class="line">            <span class="keyword">return</span> simplify(calc_apply(exp.first, arguments))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(exp + <span class="string">' is not a number or call expression'</span>)</span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">calc_apply</span><span class="params">(operator, args)</span>:</span></span><br><span class="line">        <span class="string">"""Apply the named operator to a list of args."""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(operator, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(str(operator) + <span class="string">' is not a symbol'</span>)</span><br><span class="line">        <span class="keyword">if</span> operator == <span class="string">'+'</span>:</span><br><span class="line">            <span class="keyword">return</span> reduce(add, args, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">elif</span> operator == <span class="string">'-'</span>:</span><br><span class="line">            <span class="keyword">if</span> len(args) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> TypeError(operator + <span class="string">' requires at least 1 argument'</span>)</span><br><span class="line">            <span class="keyword">elif</span> len(args) == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> -args.first</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> reduce(sub, args.second, args.first)</span><br><span class="line">        <span class="keyword">elif</span> operator == <span class="string">'*'</span>:</span><br><span class="line">            <span class="keyword">return</span> reduce(mul, args, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> operator == <span class="string">'/'</span>:</span><br><span class="line">            <span class="keyword">if</span> len(args) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> TypeError(operator + <span class="string">' requires at least 1 argument'</span>)</span><br><span class="line">            <span class="keyword">elif</span> len(args) == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>/args.first</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> reduce(truediv, args.second, args.first)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(operator + <span class="string">' is an unknown operator'</span>)</span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>calc_apply(<span class="string">'+'</span>, as_scheme_list(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>calc_apply(<span class="string">'-'</span>, as_scheme_list(<span class="number">10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>calc_apply(<span class="string">'*'</span>, nil)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>calc_apply(<span class="string">'*'</span>, as_scheme_list(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"><span class="number">120</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>calc_apply(<span class="string">'/'</span>, as_scheme_list(<span class="number">40</span>, <span class="number">5</span>))</span><br><span class="line"><span class="number">8.0</span></span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(exp)</span><br><span class="line">(+ (* <span class="number">3</span> <span class="number">4</span>) <span class="number">5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>calc_eval(exp)</span><br><span class="line"><span class="number">17</span></span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">read_eval_print_loop</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="string">"""Run a read-eval-print loop for calculator."""</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            src = buffer_input()</span><br><span class="line">            <span class="keyword">while</span> src.more_on_line:</span><br><span class="line">                expression = scheme_read(src)</span><br><span class="line">                print(calc_eval(expression))</span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; (* <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>)</span><br><span class="line"><span class="number">6</span></span><br><span class="line">&gt; (+)</span><br><span class="line"><span class="number">0</span></span><br><span class="line">&gt; (+ <span class="number">2</span> (/ <span class="number">4</span> <span class="number">8</span>))</span><br><span class="line"><span class="number">2.5</span></span><br><span class="line">&gt; (+ <span class="number">2</span> <span class="number">2</span>) (* <span class="number">3</span> <span class="number">3</span>)</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">&gt; (+ <span class="number">1</span></span><br><span class="line">     (- <span class="number">23</span>)</span><br><span class="line">     (* <span class="number">4</span> <span class="number">2.5</span>))</span><br><span class="line"><span class="number">-12</span></span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">read_eval_print_loop</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="string">"""Run a read-eval-print loop for calculator."""</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                src = buffer_input()</span><br><span class="line">                <span class="keyword">while</span> src.more_on_line:</span><br><span class="line">                    expression = scheme_read(src)</span><br><span class="line">                    print(calc_eval(expression))</span><br><span class="line">            <span class="keyword">except</span> (SyntaxError, TypeError, ValueError, ZeroDivisionError) <span class="keyword">as</span> err:</span><br><span class="line">                print(type(err).__name__ + <span class="string">':'</span>, err)</span><br><span class="line">            <span class="keyword">except</span> (KeyboardInterrupt, EOFError):  <span class="comment"># &lt;Control&gt;-D, etc.</span></span><br><span class="line">                print(<span class="string">'Calculation completed.'</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<p>next</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; )</span><br><span class="line">SyntaxError: unexpected token: )</span><br><span class="line">&gt; <span class="number">2.3</span><span class="number">.4</span></span><br><span class="line">ValueError: invalid numeral: <span class="number">2.3</span><span class="number">.4</span></span><br><span class="line">&gt; +</span><br><span class="line">TypeError: + <span class="keyword">is</span> <span class="keyword">not</span> a number <span class="keyword">or</span> call expression</span><br><span class="line">&gt; (/ <span class="number">5</span>)</span><br><span class="line">TypeError: / requires exactly <span class="number">2</span> arguments</span><br><span class="line">&gt; (/ <span class="number">1</span> <span class="number">0</span>)</span><br><span class="line">ZeroDivisionError: division by zero</span><br></pre></td></tr></table></figure>
<p>next</p>
<p>未完待续…</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2015/08/17/make-realtime-queue-use-faye-and-sidekiq/">使用faye + sidekiq制作实时消息队列</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-08-17
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>install faye and sidekiq</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gemfile</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Faye</span></span><br><span class="line">gem <span class="string">'faye-rails'</span>, <span class="string">'~&gt; 2.0.0'</span></span><br><span class="line">gem <span class="string">'faye-redis'</span>, <span class="string">'~&gt; 0.2.0'</span></span><br><span class="line">gem <span class="string">'faye'</span>,       <span class="string">'1.0.3'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sidekiq</span></span><br><span class="line">gem <span class="string">'sidekiq'</span></span><br></pre></td></tr></table></figure>
<p>编辑 config/application.rb</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config.middleware.use FayeRails::Middleware, <span class="symbol">mount:</span> <span class="string">'/faye'</span>, <span class="symbol">engine:</span> &#123;<span class="symbol">type:</span> Faye::Redis, <span class="symbol">uri:</span> <span class="string">"<span class="subst">#&#123;ENV[<span class="string">'REDIS_URL'</span>]&#125;</span>/4"</span>&#125;, <span class="symbol">:timeout</span> =&gt; <span class="number">25</span> <span class="keyword">do</span></span><br><span class="line">     map <span class="string">'/api/questions/status'</span> =&gt; Api::QuestionStateController</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>增加worker类</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/workers/question_state_worker.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuestionStateWorker</span></span></span><br><span class="line">  <span class="keyword">include</span> Sidekiq::Worker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_question_state</span><span class="params">(user_id)</span></span></span><br><span class="line">    Question.where(<span class="string">"user_id = ? and finished= ?"</span>, user_id, <span class="literal">false</span>).select(<span class="string">"id,user_id,has_teacher_answer"</span>).to_json</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">keep_state</span><span class="params">(user_id, data)</span></span></span><br><span class="line">    $redis.set <span class="string">"questions_state_<span class="subst">#&#123;user_id&#125;</span>"</span>, data</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">perform</span><span class="params">(user_id)</span></span></span><br><span class="line">    keep_state(user_id, get_question_state(user_id))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>监听数据库</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># app/realtime/api/question_state_controller.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::QuestionStateController</span> &lt; FayeRails::Controller</span></span><br><span class="line">  observe Question, <span class="symbol">:after_save</span> <span class="keyword">do</span> <span class="params">|question|</span></span><br><span class="line">    QuestionStateWorker.perform_async(question.user_id)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2015/03/26/make-brainfuck-interpreter-with-nim/">brainfuck解释器的实现(一)</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-03-26
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>Brainfuck，是一种极小化的，符合图灵完全思想的编程语言。更多资料<a href="http://zh.wikipedia.org/wiki/Brainfuck" target="_blank" rel="noopener">Brainfuck</a></p>
<p>这种语言基于一个简单的机器模型，除了指令，这个机器还包括：一个以字节为单位、被初始化为零的数组、一个指向该数组的指针（初始时指向数组的第一个字节）、以及用于输入输出的两个字节流。</p>
<p>开始实现（使用nim）：<br>1 . 读取输入的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">let code = if paramCount() &gt; 0: readFile paramStr(1)</span><br><span class="line">           else: readAll stdin</span><br></pre></td></tr></table></figure>
<p>2 . 创建初始值为0的数组，并初始一个指向它的指针</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var</span><br><span class="line">  tape: seq[char] = newSeq[char]()</span><br><span class="line">  codePos: int = 0</span><br><span class="line">  tapePos: int = 0</span><br></pre></td></tr></table></figure>
<p>3 . 根据输入来做相应操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">case code[codePos]</span><br><span class="line">of &apos;+&apos;: inc tape[tapePos]</span><br><span class="line">of &apos;-&apos;: dec tape[tapePos]</span><br><span class="line">of &apos;&gt;&apos;: inc tapePos</span><br><span class="line">of &apos;&lt;&apos;: dec tapePos</span><br><span class="line">of &apos;.&apos;: stdout.write tape[tapePos]</span><br><span class="line">of &apos;,&apos;: tape[tapePos] = stdin.readChar</span><br><span class="line">else: discard</span><br></pre></td></tr></table></figure>
<p>4 . 处理“[”跟“]”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if code[codePos] == &apos;[&apos;:</span><br><span class="line">  inc codePos</span><br><span class="line">  let oldPos = codePos</span><br><span class="line">  while run(tape[tapePos] == &apos;\0&apos;):</span><br><span class="line">    codePos = oldPos</span><br><span class="line">elif code[codePos] == &apos;]&apos;:</span><br><span class="line">  return tape[tapePos] != &apos;\0&apos;</span><br></pre></td></tr></table></figure>
<p>至此，解释器完成，但是处理速度相当慢…<br>完整代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">let code = if paramCount() &gt; 0: readFile paramStr(1)</span><br><span class="line">           else: readAll stdin</span><br><span class="line"></span><br><span class="line">var</span><br><span class="line">  tape: seq[char] = newSeq[char]()</span><br><span class="line">  codePos: int = 0</span><br><span class="line">  tapePos: int = 0</span><br><span class="line">  </span><br><span class="line">proc run(skip = false): bool =</span><br><span class="line">  # echo &quot;codePos: &quot;, codePos, &quot; tapePos:&quot;, tapePos</span><br><span class="line">  while tapePos &gt;= 0 and codePos &lt; code.len:</span><br><span class="line">    if tapePos &gt;= tape.len:</span><br><span class="line">      tape.add &apos;\0&apos;</span><br><span class="line">    if code[codePos] == &apos;[&apos;:</span><br><span class="line">      inc codePos</span><br><span class="line">      let oldPos = codePos</span><br><span class="line">      while run(tape[tapePos] == &apos;\0&apos;):</span><br><span class="line">        codePos = oldPos</span><br><span class="line">    elif code[codePos] == &apos;]&apos;:</span><br><span class="line">      return tape[tapePos] != &apos;\0&apos;</span><br><span class="line">    elif not skip:</span><br><span class="line">      case code[codePos]</span><br><span class="line">      of &apos;+&apos;: inc tape[tapePos]</span><br><span class="line">      of &apos;-&apos;: dec tape[tapePos]</span><br><span class="line">      of &apos;&gt;&apos;: inc tapePos</span><br><span class="line">      of &apos;&lt;&apos;: dec tapePos</span><br><span class="line">      of &apos;.&apos;: stdout.write tape[tapePos]</span><br><span class="line">      of &apos;,&apos;: tape[tapePos] = stdin.readChar</span><br><span class="line">      else: discard</span><br><span class="line">    </span><br><span class="line">    inc codePos</span><br><span class="line"></span><br><span class="line">discard run()</span><br></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2015/01/20/get-real-deploy-with-puma/">实现网打算换成puma来跑</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-01-20
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>将unicorn换成puma的原因：</p>
<ul>
<li>节省内存 ，提高效率</li>
<li>Capistrano部署集成（capistrano3-puma）</li>
</ul>
<p>以下为手动配置方法：<br>启动puma<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle exec puma -b unix:///tmp/puma.sock -e production --daemon</span><br></pre></td></tr></table></figure></p>
<p>nginx配置例子：<br>​<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">upstream shixian &#123;</span><br><span class="line">  server unix:///tmp/puma.sock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name dev.shixian.com;</span><br><span class="line"></span><br><span class="line">  # ~2 seconds is often enough for most folks to parse HTML/CSS and</span><br><span class="line">  # retrieve needed images/icons/frames, connections are cheap in</span><br><span class="line">  # nginx so increasing this is generally safe...</span><br><span class="line">  keepalive_timeout 5;</span><br><span class="line"></span><br><span class="line">  # path for static files</span><br><span class="line">  root /home/deploy/apps/shixian/public;</span><br><span class="line">  access_log /home/deploy/apps/shixian/log/nginx.access.log;</span><br><span class="line">  error_log /home/deploy/apps/shixian/log/nginx.error.log info;</span><br><span class="line"></span><br><span class="line">  # this rewrites all the requests to the maintenance.html</span><br><span class="line">  # page if it exists in the doc root. This is for capistrano&apos;s</span><br><span class="line">  # disable web task</span><br><span class="line">  if (-f $document_root/maintenance.html) &#123;</span><br><span class="line">    rewrite  ^(.*)$  /maintenance.html last;</span><br><span class="line">    break;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line"></span><br><span class="line">    # If the file exists as a static file serve it directly without</span><br><span class="line">    # running all the other rewite tests on it</span><br><span class="line">    if (-f $request_filename) &#123;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # check for index.html for directory index</span><br><span class="line">    # if its there on the filesystem then rewite</span><br><span class="line">    # the url to add /index.html to the end of it</span><br><span class="line">    # and then break to send it to the next config rules.</span><br><span class="line">    if (-f $request_filename/index.html) &#123;</span><br><span class="line">      rewrite (.*) $1/index.html break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # this is the meat of the rack page caching config</span><br><span class="line">    # it adds .html to the end of the url and then checks</span><br><span class="line">    # the filesystem for that file. If it exists, then we</span><br><span class="line">    # rewite the url to have explicit .html on the end</span><br><span class="line">    # and then send it on its way to the next config rule.</span><br><span class="line">    # if there is no file on the fs then it sets all the</span><br><span class="line">    # necessary headers and proxies to our upstream pumas</span><br><span class="line">    if (-f $request_filename.html) &#123;</span><br><span class="line">      rewrite (.*) $1.html break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!-f $request_filename) &#123;</span><br><span class="line">      proxy_pass http://shixian;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # Now this supposedly should work as it gets the filenames with querystrings that Rails provides.</span><br><span class="line">  # BUT there&apos;s a chance it could break the ajax calls.</span><br><span class="line">  location ~* \.(ico|css|gif|jpe?g|png|js)(\?[0-9]+)?$ &#123;</span><br><span class="line">     expires max;</span><br><span class="line">     break;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # Error pages</span><br><span class="line">  # error_page 500 502 503 504 /500.html;</span><br><span class="line">  location = /500.html &#123;</span><br><span class="line">    root /home/deploy/apps/shixian/public;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2015/01/08/push-notifications-for-ios-with-houston-and-sidekiq/">使用Houston+Sidekiq做ios消息推送</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-01-08
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>创建<code>NotifierWorker</code>类<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/workers/notifier_worker.rb</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'apn_connection'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotifierWorker</span></span></span><br><span class="line">  <span class="keyword">include</span> Sidekiq::Worker</span><br><span class="line"></span><br><span class="line">  APN_POOL = ConnectionPool.new(<span class="symbol">:size</span> =&gt; <span class="number">2</span>, <span class="symbol">:timeout</span> =&gt; <span class="number">300</span>) <span class="keyword">do</span></span><br><span class="line">    APNConnection.new</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">​</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">perform</span><span class="params">(message,  custom_data = <span class="literal">nil</span>)</span></span></span><br><span class="line">    APN_POOL.with <span class="keyword">do</span> <span class="params">|connection|</span></span><br><span class="line">      token = <span class="string">"&lt;dccec3dd 25936d87 5ed2d16b 75f0785c bdb0b33d 8dd48f1c 72529c00 b1c56a19&gt;"</span></span><br><span class="line">      notification = Houston::Notification.new(<span class="symbol">device:</span> token)</span><br><span class="line">      notification.alert = message</span><br><span class="line">      notification.sound = <span class="string">'default'</span></span><br><span class="line">      notification.custom_data = custom_data</span><br><span class="line">      connection.write(notification.message)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>创建<code>APNConnection</code>类<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lib/apn_connection.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APNConnection</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">    setup</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">    @uri, @certificate = <span class="keyword">if</span> Rails.env.production?</span><br><span class="line">      [</span><br><span class="line">        Houston::APPLE_PRODUCTION_GATEWAY_URI,</span><br><span class="line">        File.read(<span class="string">"<span class="subst">#&#123;Rails.root&#125;</span>/config/shixian-production.pem"</span>)</span><br><span class="line">      ]</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      [</span><br><span class="line">        Houston::APPLE_DEVELOPMENT_GATEWAY_URI,</span><br><span class="line">        File.read(<span class="string">"<span class="subst">#&#123;Rails.root&#125;</span>/config/shixian-development.pem"</span>)</span><br><span class="line">      ]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    @connection = Houston::Connection.new(@uri, @certificate, <span class="literal">nil</span>)</span><br><span class="line">    @connection.open</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      raise <span class="string">"Connection is closed"</span> <span class="keyword">unless</span> @connection.open?</span><br><span class="line">      @connection.write(data)</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">      attempts <span class="params">||</span>= <span class="number">0</span></span><br><span class="line">      attempts += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> attempts &lt; <span class="number">5</span></span><br><span class="line">        setup</span><br><span class="line">        <span class="keyword">retry</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        raise e</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NotifierWorker.perform_async(&quot;hello&quot;,&quot;s&quot; =&gt; &quot;1,Notification&quot;)</span><br></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2014/12/02/metaprogramming-ruby-object/">ruby元编程-对象模型</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-12-02
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h1 id="ruby中的对象"><a href="#ruby中的对象" class="headerlink" title="ruby中的对象"></a>ruby中的对象</h1><p>在ruby中任何东西都是对象，甚至是nil、类等都是对象。<br>比如下面的例子：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span> <span class="number">1</span>.methods</span><br><span class="line">=&gt; [<span class="symbol">:to_s</span>, <span class="symbol">:inspect</span>, <span class="symbol">:-@</span>, <span class="symbol">:+</span>, <span class="symbol">:-</span>, <span class="symbol">:*</span>, <span class="symbol">:/</span>, <span class="symbol">:div</span>, <span class="symbol">:%</span>, <span class="symbol">:modulo</span>, <span class="symbol">:divmod</span>, <span class="symbol">:fdiv</span>, <span class="symbol">:**</span>, <span class="symbol">:abs</span>, <span class="symbol">:magnitude</span>, <span class="symbol">:==</span>, <span class="symbol">:===</span>, <span class="symbol">:&lt;=&gt;</span>, <span class="symbol">:&gt;</span>, <span class="symbol">:&gt;=</span>, <span class="symbol">:&lt;</span>, <span class="symbol">:&lt;=</span>, <span class="symbol">:~</span>, <span class="symbol">:&amp;</span>, <span class="symbol">:|</span>, <span class="symbol">:^</span>, <span class="symbol">:[]</span>, <span class="symbol">:&lt;&lt;</span>, <span class="symbol">:&gt;&gt;</span>, <span class="symbol">:to_f</span>, <span class="symbol">:size</span>, <span class="symbol">:bit_length</span>, <span class="symbol">:zero?</span>, <span class="symbol">:odd?</span>, <span class="symbol">:even?</span>, <span class="symbol">:succ</span>, <span class="symbol">:integer?</span>, <span class="symbol">:upto</span>, <span class="symbol">:downto</span>, <span class="symbol">:times</span>, <span class="symbol">:next</span>, <span class="symbol">:pred</span>, <span class="symbol">:chr</span>, <span class="symbol">:ord</span>, <span class="symbol">:to_i</span>, <span class="symbol">:to_int</span>, <span class="symbol">:floor</span>, <span class="symbol">:ceil</span>, <span class="symbol">:truncate</span>, <span class="symbol">:round</span>, <span class="symbol">:gcd</span>, <span class="symbol">:lcm</span>, <span class="symbol">:gcdlcm</span>, <span class="symbol">:numerator</span>, <span class="symbol">:denominator</span>, <span class="symbol">:to_r</span>, <span class="symbol">:rationalize</span>, <span class="symbol">:singleton_method_added</span>, <span class="symbol">:coerce</span>, <span class="symbol">:i</span>, <span class="symbol">:+@</span>, <span class="symbol">:eql?</span>, ......]</span><br><span class="line"><span class="meta">&gt;&gt;</span> <span class="number">1</span>.class</span><br><span class="line">=&gt; Fixnum</span><br><span class="line"><span class="meta">&gt;&gt;</span> Fixnum.class</span><br><span class="line">=&gt; Class</span><br><span class="line"><span class="meta">&gt;&gt;</span> Class.class</span><br><span class="line">=&gt; Class</span><br></pre></td></tr></table></figure></p>
<p>在ruby中对象是由一组实例变量和一个类的引用组成的，对象的方法存在于对象所在的类中。</p>
<h1 id="猴子补丁"><a href="#猴子补丁" class="headerlink" title="猴子补丁"></a>猴子补丁</h1><p>所谓猴子补丁就是不改变源代码而对功能进行追加和变更。</p>
<h3 id="开放类"><a href="#开放类" class="headerlink" title="开放类"></a>开放类</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span></span></span><br><span class="line">        <span class="string">"hello world !"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">plus</span><span class="params">(arg1,arg2)</span></span></span><br><span class="line">        arg1 + arg2</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="meta">&gt;&gt;</span> foo = Foo.new</span><br><span class="line">=&gt; #&lt;Foo:0xb8c2b574&gt;</span><br><span class="line"><span class="meta">&gt;&gt;</span> foo.hello</span><br><span class="line">=&gt; <span class="string">"hello world !"</span></span><br><span class="line"><span class="meta">&gt;&gt;</span> foo.plus(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">=&gt; <span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>第二个class Foo中并不是新建了一个Foo类，而是重新打开了Foo类，给其新增了一个叫plus的方法。在ruby中所有的类都是开放类，你可以自由的开发String、Fixnum等基本的数据类型给它增加功能.</p>
<h1 id="ruby中的类"><a href="#ruby中的类" class="headerlink" title="ruby中的类"></a>ruby中的类</h1><p>上文说类也是一个对象，那么什么是类呢？所谓类就是一个Class类的实例加一组实例方法和一个对其父类的引用。既然这样，就可以这样定义一个类，虽然结果也会产生一个类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello = Class.new</span><br></pre></td></tr></table></figure></p>
<p>一般情况下，类这么定义：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class Hello</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>其区别在于Hello是个常量（在ruby中，任何以大写字母开头的引用即为常量）而已。那么，class 包裹起来的一块东西又是什么呢？其只不过是个作用域。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span></span><br><span class="line">    puts <span class="string">"hello world"</span></span><br><span class="line">    <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">say</span></span></span><br><span class="line">        <span class="string">"hello sllt"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h1 id="self"><a href="#self" class="headerlink" title="self"></a>self</h1><p>每一行代码都会在一个对象中执行，这个对象就是当前对象（self)。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">    <span class="keyword">self</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">=&gt; MyClass</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">say</span></span></span><br><span class="line">        <span class="string">"hello"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put_self</span></span></span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">        say</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;</span> m = MyClass.new</span><br><span class="line"><span class="meta">&gt;&gt;</span> m.put_self</span><br><span class="line">=&gt; #&lt;MyClass:0xb93de870&gt; <span class="string">"hello"</span></span><br></pre></td></tr></table></figure></p>
<p>通过上面代码可以看出：</p>
<ul>
<li>当定义一个模块和类时，其自身扮演self的角色。</li>
<li>当调用一个方法时，接收者会扮演self的角色。</li>
</ul>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2014/11/13/use-markdown-in-rails/">在Rails中实现markdown解析</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-11-13
        </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>首先，安装gem<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;redcarpet&apos;</span><br></pre></td></tr></table></figure></p>
<p>然后在app/helpers/application_helper.rb添加如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">def markdown(text)</span><br><span class="line">    render_options = &#123;</span><br><span class="line">        filter_html:     false,</span><br><span class="line">        hard_wrap:       true, </span><br><span class="line">        link_attributes: &#123; rel: &apos;nofollow&apos; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    renderer = Redcarpet::Render::HTML.new(render_options)</span><br><span class="line">    extensions = &#123;</span><br><span class="line">            #will parse links without need of enclosing them</span><br><span class="line">            autolink:           true,</span><br><span class="line">            fenced_code_blocks: true,</span><br><span class="line">            # will ignore standard require for empty lines surrounding HTML blocks</span><br><span class="line">            lax_spacing:        true,</span><br><span class="line">            # will not generate emphasis inside of words, for example no_emph_no</span><br><span class="line">            no_intra_emphasis:  true,</span><br><span class="line">            # will parse strikethrough from ~~, for example: ~~bad~~</span><br><span class="line">            strikethrough:      true,</span><br><span class="line">            # will parse superscript after ^, you can wrap superscript in () </span><br><span class="line">            superscript:        true</span><br><span class="line">            # will require a space after # in defining headers</span><br><span class="line">            # space_after_headers: true</span><br><span class="line">        &#125;</span><br><span class="line">    Redcarpet::Markdown.new(renderer, extensions).render(text).html_safe</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>在view中:<br><code>&lt;%= markdown @content %&gt;</code></p>
<p>在controller中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class ApplicationController &lt; ActionController::Base</span><br><span class="line">    include ApplicationHelper</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:hi@sllt.me" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/sllt" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">sllt</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.9.0"></script>

  </body>
</html>
